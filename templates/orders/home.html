{% extends 'base/base.html' %}
{% load static %}

{% block title %}Smart Food Stall - Pre-Order Your Meal{% endblock %}

{% block content %}

<!-- Hero Section -->
<section class="hero">
    <div class="hero-content">
        <div class="hero-badge">üöÄ Skip the Queue</div>
        <h1 class="hero-title">Pre-Order Your Food.<br><span class="gradient-text">Skip the Wait.</span></h1>
        <p class="hero-subtitle">Order from your favorite campus food stalls before your break. Pick up instantly, no waiting in line.</p>
        <div class="hero-actions">
            {% if user.is_authenticated %}
            <a href="{% url 'stall_list' %}" class="btn btn-primary btn-large">Browse Stalls <i class="fas fa-arrow-right"></i></a>
            <a href="{% url 'my_orders' %}" class="btn btn-outline btn-large">My Orders</a>
            {% else %}
            <a href="{% url 'register' %}" class="btn btn-primary btn-large">Get Started Free <i class="fas fa-arrow-right"></i></a>
            <a href="{% url 'stall_list' %}" class="btn btn-outline btn-large">Browse Menu</a>
            {% endif %}
        </div>
        <div class="hero-stats">
            <div class="hero-stat">
                <span class="hero-stat-num">{{ today_total_orders }}</span>
                <span class="hero-stat-label">Orders Today</span>
            </div>
            <div class="hero-stat">
                <span class="hero-stat-num">{{ stalls|length }}+</span>
                <span class="hero-stat-label">Food Stalls</span>
            </div>
            <div class="hero-stat">
                <span class="hero-stat-num">~5min</span>
                <span class="hero-stat-label">Avg Wait Time</span>
            </div>
        </div>
    </div>
    <div class="hero-visual">
        <div class="hero-card floating">
            <div class="hero-card-icon">üçï</div>
            <div class="hero-card-text">
                <strong>Order Ready!</strong>
                <span>Token #12024 ‚Ä¢ Stall A</span>
            </div>
        </div>
        <div class="hero-card-bg"></div>
    </div>
</section>

<!-- Live Slot Demand -->
<section class="section">
    <div class="container">
        <div class="section-header">
            <h2><i class="fas fa-chart-bar text-primary"></i> Live Break Slot Status</h2>
            <p>Real-time crowd levels ‚Äî choose the best time for your pickup</p>
            <span class="live-badge"><span class="live-dot"></span> Live</span>
        </div>
        <div class="slot-grid" id="slotGrid">
            {% for slot in slot_info %}
            <div class="slot-card slot-{{ slot.level }}">
                <div class="slot-time">{{ slot.label }}</div>
                <div class="slot-orders">
                    <span class="slot-count">{{ slot.count }}</span>
                    <span class="slot-label">orders</span>
                </div>
                <div class="slot-bar">
                    <div class="slot-fill" style="width: {% widthratio slot.count 50 100 %}%"></div>
                </div>
                <div class="slot-status slot-status-{{ slot.level }}">
                    {% if slot.level == 'low' %}<i class="fas fa-smile"></i> Available
                    {% elif slot.level == 'medium' %}<i class="fas fa-meh"></i> Moderate
                    {% else %}<i class="fas fa-fire"></i> Peak Hour
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        <p class="slot-refresh-note"><i class="fas fa-sync-alt"></i> Refreshes every 30 seconds</p>
    </div>
</section>

<!-- How It Works -->
<section class="section section-alt">
    <div class="container">
        <div class="section-header">
            <h2>How It Works</h2>
            <p>Order in 3 simple steps</p>
        </div>
        <div class="steps-grid">
            <div class="step-card">
                <div class="step-icon">üîç</div>
                <div class="step-num">1</div>
                <h3>Browse & Select</h3>
                <p>Explore food stalls, view menus with prices and nutrition info, and add items to your cart.</p>
            </div>
            <div class="step-card">
                <div class="step-icon">‚è∞</div>
                <div class="step-num">2</div>
                <h3>Choose Your Slot</h3>
                <p>Pick your preferred break time. Our AI recommends the least crowded slot for you.</p>
            </div>
            <div class="step-card">
                <div class="step-icon">üéüÔ∏è</div>
                <div class="step-num">3</div>
                <h3>Pick Up & Enjoy</h3>
                <p>Get a token number. Your food is ready when you arrive ‚Äî no waiting!</p>
            </div>
        </div>
    </div>
</section>

<!-- Featured Stalls -->
{% if stalls %}
<section class="section">
    <div class="container">
        <div class="section-header">
            <h2>Featured Stalls</h2>
            <a href="{% url 'stall_list' %}" class="view-all-link">View All <i class="fas fa-arrow-right"></i></a>
        </div>
        <div class="stall-grid">
            {% for stall in stalls %}
            <a href="{% url 'stall_detail' stall.pk %}" class="stall-card">
                <div class="stall-image">
                    {% if stall.image %}
                    <img src="{{ stall.image.url }}" alt="{{ stall.name }}">
                    {% else %}
                    <div class="stall-image-placeholder">
                        <i class="fas fa-store"></i>
                    </div>
                    {% endif %}
                    <div class="stall-badge {% if stall.is_open %}badge-open{% else %}badge-closed{% endif %}">
                        {% if stall.is_open %}Open{% else %}Closed{% endif %}
                    </div>
                </div>
                <div class="stall-info">
                    <h3>{{ stall.name }}</h3>
                    <p>{{ stall.description|truncatechars:60 }}</p>
                    <div class="stall-meta">
                        <span><i class="fas fa-star text-yellow"></i> {{ stall.avg_rating }}</span>
                        <span><i class="fas fa-map-marker-alt text-primary"></i> {{ stall.location }}</span>
                    </div>
                    <span class="btn btn-sm btn-primary">Order Now</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh slot demand every 30 seconds
setInterval(() => {
    fetch('/api/slot-demand/?date=' + new Date().toISOString().slice(0,10))
        .then(r => r.json())
        .then(data => updateSlotGrid(data.slots))
        .catch(() => {});
}, 30000);

function updateSlotGrid(slots) {
    const cards = document.querySelectorAll('.slot-card');
    slots.forEach((slot, i) => {
        if (cards[i]) {
            cards[i].className = `slot-card slot-${slot.level}`;
            cards[i].querySelector('.slot-count').textContent = slot.count;
        }
    });
}
</script>
{% endblock %}
